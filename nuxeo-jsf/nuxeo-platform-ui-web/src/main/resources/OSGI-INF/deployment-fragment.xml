<?xml version="1.0"?>
<fragment version="1">

  <require>org.nuxeo.ecm.platform.ui.jsf</require>

  <extension target="web#LISTENER">
    <listener>
      <listener-class>org.jboss.seam.servlet.SeamListener</listener-class>
    </listener>
  </extension>

  <!-- AT: mixing filters and mappings for clarity, does not change
    resulting web.xml file -->

  <extension target="web#STD-AUTH-FILTER">
    <!-- auth filter configuration, filter is defined in web-common -->
    <filter-mapping>
      <filter-name>NuxeoAuthenticationFilter</filter-name>
      <url-pattern>/seam/*</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>
    <filter-mapping>
      <filter-name>NuxeoAuthenticationFilter</filter-name>
      <url-pattern>/restAPI/*</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>
    <!-- filter also requests for web services -->
    <filter-mapping>
      <filter-name>NuxeoAuthenticationFilter</filter-name>
      <url-pattern>/ws/*</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>
    <filter-mapping>
      <filter-name>NuxeoAuthenticationFilter</filter-name>
      <url-pattern>/webservices/*</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>
  </extension>

  <extension target="web#FILTER">
    <filter>
      <filter-name>Seam Filter</filter-name>
      <filter-class>org.jboss.seam.servlet.SeamFilter</filter-class>
    </filter>

    <filter-mapping>
      <filter-name>Seam Filter</filter-name>
      <url-pattern>*.seam</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>

    <filter-mapping>
      <filter-name>Seam Filter</filter-name>
      <url-pattern>*.faces</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>

    <filter-mapping>
      <filter-name>Seam Filter</filter-name>
      <url-pattern>*.xhtml</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>

    <!-- filter for web services configuration -->
    <filter>
      <filter-name>Seam Context Filter</filter-name>
      <filter-class>org.jboss.seam.web.ContextFilter</filter-class>
    </filter>

  </extension>

  <!-- AT: mixing servlets and mappings for clarity, does not change
    resulting web.xml file -->
  <extension target="web#SERVLET">

    <servlet>
      <servlet-name>Seam Ressource Servlet</servlet-name>
      <servlet-class>org.jboss.seam.servlet.SeamResourceServlet</servlet-class>
    </servlet>

    <servlet-mapping>
      <servlet-name>Seam Ressource Servlet</servlet-name>
      <url-pattern>/seam/resource/*</url-pattern>
    </servlet-mapping>

    <!-- restlet API mapping -->
    <servlet>
      <servlet-name>Nuxeo Restlet Servlet</servlet-name>
      <servlet-class>
        org.nuxeo.ecm.platform.ui.web.restAPI.RestletServlet
      </servlet-class>
    </servlet>

    <servlet-mapping>
      <servlet-name>Nuxeo Restlet Servlet</servlet-name>
      <url-pattern>/restAPI/*</url-pattern>
    </servlet-mapping>

    <!-- pdf/csv/excel JSF servlet -->
    <servlet>
      <servlet-name>Document Store Servlet</servlet-name>
      <servlet-class>
        org.jboss.seam.document.DocumentStoreServlet
      </servlet-class>
    </servlet>

    <servlet-mapping>
      <servlet-name>Document Store Servlet</servlet-name>
      <url-pattern>*.pdf</url-pattern>
    </servlet-mapping>
    <servlet-mapping>
      <servlet-name>Document Store Servlet</servlet-name>
      <url-pattern>*.csv</url-pattern>
    </servlet-mapping>
    <servlet-mapping>
      <servlet-name>Document Store Servlet</servlet-name>
      <url-pattern>*.xls</url-pattern>
    </servlet-mapping>

  </extension>

  <extension target="faces-config#NAVIGATION">

    <!-- register seam template so that excel generation plays
      well with url service -->
    <navigation-case>
      <from-outcome>seam_docstore</from-outcome>
      <to-view-id>/seam-docstore.xhtml</to-view-id>
      <redirect />
    </navigation-case>

  </extension>

  <extension target="web#CONTEXT-PARAM">

    <!-- FIXME: disabled for now + need to move libs to META-INF -->
    <!--
      <context-param>
      <param-name>facelets.LIBRARIES</param-name>
      <param-value>
      /WEB-INF/nxweb-pdf.taglib.xml;
      /WEB-INF/nx-seam-excel.taglib.xml;
      /WEB-INF/nx-seam-rss.taglib.xml;
      </param-value>
      </context-param>
    -->

  </extension>

  <extension target="faces-config#APPLICATION">
    <!-- This line should not strictly speaking be necessary, but it works
      around a minor bug in the RI.) -->
    <el-resolver>org.jboss.seam.el.SeamELResolver</el-resolver>
  </extension>

  <extension target="faces-config#FACTORY">
    <!-- TODO: remove? -->
    <lifecycle-factory>
      org.nuxeo.ecm.platform.ui.web.lifecycle.NuxeoLifeCycleFactory
    </lifecycle-factory>
  </extension>

  <extension target="faces-config#COMPONENT">

    <!-- override of buggy seam libraries -->
    <component>
      <component-type>
        org.nuxeo.ecm.platform.ui.web.component.seam.UIFeed
      </component-type>
      <component-class>
        org.nuxeo.ecm.platform.ui.web.component.seam.UIFeed
      </component-class>
    </component>

    <component>
      <component-type>
        org.nuxeo.ecm.platform.ui.web.component.seam.UIColumn
      </component-type>
      <component-class>
        org.nuxeo.ecm.platform.ui.web.component.seam.UIColumn
      </component-class>
    </component>

    <component>
      <component-type>
        org.nuxeo.ecm.platform.ui.web.component.seam.UICellExcel
      </component-type>
      <component-class>
        org.nuxeo.ecm.platform.ui.web.component.seam.UICellExcel
      </component-class>
    </component>

    <component>
      <component-type>
        org.nuxeo.ecm.platform.ui.web.component.seam.UIHtmlText
      </component-type>
      <component-class>
        org.nuxeo.ecm.platform.ui.web.component.seam.UIHtmlText
      </component-class>
    </component>

    <component>
      <component-type>
        org.nuxeo.ecm.platform.ui.web.component.seam.UIImage
      </component-type>
      <component-class>
        org.nuxeo.ecm.platform.ui.web.component.seam.UIImage
      </component-class>
    </component>

    <!-- end of override of buggy seam libraries -->

  </extension>

  <!-- TODO: re-enable? -->
  <!--
    <install>
    <delete path="nxwebplatform.tmp" />
    <mkdir path="nxwebplatform.tmp" />
    <unzip from="${bundle.fileName}" to="nxwebplatform.tmp">
    <include>WEB/**</include>
    </unzip>
    <copy from="nxwebplatform.tmp/WEB/" to="nuxeo.war/WEB-INF/" />
    <delete path="nxwebplatform.tmp" />
    </install>
  -->

</fragment>

