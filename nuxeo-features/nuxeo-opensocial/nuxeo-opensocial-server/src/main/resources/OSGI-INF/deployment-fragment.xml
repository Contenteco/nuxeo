<?xml version="1.0"?>
<fragment>



  <extension target="application#MODULE">
    <module>
      <java>${bundle.fileName}</java>
    </module>
  </extension>

  <extension target="web#CONTEXT-PARAM">
    <context-param>
      <param-name>guice-modules</param-name>
      <param-value>
        org.nuxeo.opensocial.shindig.NuxeoPropertiesModule:
        org.nuxeo.opensocial.shindig.ProxyModule:
        org.nuxeo.opensocial.services.NXGuiceModule:
        org.apache.shindig.social.core.config.SocialApiGuiceModule:
        org.nuxeo.opensocial.services.NuxeoServiceModule:
        org.nuxeo.opensocial.services.NuxeoCryptoModule:
        org.nuxeo.opensocial.shindig.gadgets.NXGadgetModule:
        org.apache.shindig.gadgets.oauth.OAuthModule:
        org.apache.shindig.common.cache.ehcache.EhCacheModule
      </param-value>
    </context-param>
  </extension>

  <extension target="web#AUTH-FILTER">
    <filter>
      <filter-name>authFilter</filter-name>
      <filter-class>org.apache.shindig.auth.AuthenticationServletFilter
      </filter-class>
    </filter>
  </extension>

  <extension target="web#LISTENER">
    <listener>
      <listener-class>
        org.nuxeo.opensocial.servlet.GuiceContextListener
      </listener-class>
    </listener>
  </extension>

  <extension target="web#FILTER-MAPPING">
    <filter-mapping>
      <filter-name>authFilter</filter-name>
      <url-pattern>/opensocial/social/*</url-pattern>
    </filter-mapping>

    <filter-mapping>
      <filter-name>authFilter</filter-name>
      <url-pattern>/opensocial/gadgets/ifr</url-pattern>
    </filter-mapping>

    <filter-mapping>
      <filter-name>authFilter</filter-name>
      <url-pattern>/opensocial/gadgets/makeRequest</url-pattern>
    </filter-mapping>

    <filter-mapping>
      <filter-name>authFilter</filter-name>
      <url-pattern>/gadgets/*</url-pattern>
    </filter-mapping>
  </extension>

  <extension target="web#STD-AUTH-FILTER">
    <filter>
      <display-name>Nuxeo Security Filter</display-name>
      <filter-name>NuxeoAuthenticationFilter
            </filter-name>
      <filter-class>
        org.nuxeo.ecm.platform.ui.web.auth.NuxeoAuthenticationFilter
      </filter-class>
    </filter>

    <filter-mapping>
      <filter-name>NuxeoAuthenticationFilter
      </filter-name>
      <url-pattern>/opensocial/gadgets/ifr/*</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>
    <filter-mapping>
      <filter-name>NuxeoAuthenticationFilter
      </filter-name>
      <url-pattern>/opensocial/social/*</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>
    <filter-mapping>
      <filter-name>NuxeoAuthenticationFilter
      </filter-name>
      <url-pattern>/opensocial/gadgets/makeRequest</url-pattern>
      <dispatcher>REQUEST</dispatcher>
      <dispatcher>FORWARD</dispatcher>
    </filter-mapping>
  </extension>


  <extension target="web#SERVLET">
    <!-- Render a Gadget -->
    <servlet>
      <servlet-name>xml-to-html</servlet-name>
      <servlet-class>
        org.apache.shindig.gadgets.servlet.GadgetRenderingServlet
      </servlet-class>
    </servlet>

    <!-- Proxy -->
    <servlet>
      <servlet-name>proxy</servlet-name>
      <servlet-class>
        org.apache.shindig.gadgets.servlet.ProxyServlet
      </servlet-class>
    </servlet>

    <servlet>
      <servlet-name>concat</servlet-name>
      <servlet-class>
        org.apache.shindig.gadgets.servlet.ConcatProxyServlet
    </servlet-class>
    </servlet>


    <!-- makeRequest -->
    <servlet>
      <servlet-name>makeRequest</servlet-name>
      <servlet-class>
        org.apache.shindig.gadgets.servlet.MakeRequestServlet
      </servlet-class>
    </servlet>

    <!-- OAuth callback -->
    <servlet>
      <servlet-name>oauthCallback</servlet-name>
      <servlet-class>
        org.apache.shindig.gadgets.servlet.OAuthCallbackServlet
      </servlet-class>
    </servlet>

    <!-- Metadata RPC -->
    <servlet>
      <servlet-name>metadata</servlet-name>
      <servlet-class>
        org.apache.shindig.gadgets.servlet.RpcServlet
      </servlet-class>
    </servlet>

    <!-- Serve gadgets RPC api -->
    <servlet>
      <servlet-name>gadgetsJsonRpcServlet</servlet-name>
      <servlet-class>
        org.apache.shindig.protocol.JsonRpcServlet
      </servlet-class>
      <init-param>
        <param-name>handlers</param-name>
        <param-value>org.apache.shindig.gadgets.handlers</param-value>
      </init-param>
    </servlet>

    <servlet>
      <servlet-name>gadgetsRestapiServlet</servlet-name>
      <servlet-class>
        org.apache.shindig.protocol.DataServiceServlet
      </servlet-class>
      <init-param>
        <param-name>handlers</param-name>
        <param-value>org.apache.shindig.gadgets.handlers</param-value>
      </init-param>
    </servlet>


    <!-- javascript serving -->
    <servlet>
      <servlet-name>js</servlet-name>
      <servlet-class>org.apache.shindig.gadgets.servlet.JsServlet
      </servlet-class>
    </servlet>
  </extension>

  <extension target="web#SERVLET-MAPPING">
    <servlet-mapping>
      <servlet-name>js</servlet-name>
      <url-pattern>/opensocial/gadgets/js/*</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
      <servlet-name>proxy</servlet-name>
      <url-pattern>/opensocial/gadgets/proxy/*</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
      <servlet-name>makeRequest</servlet-name>
      <url-pattern>/opensocial/gadgets/makeRequest</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
      <servlet-name>concat</servlet-name>
      <url-pattern>/opensocial/gadgets/concat</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
      <servlet-name>oauthCallback</servlet-name>
      <url-pattern>/opensocial/gadgets/oauthcallback</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
      <servlet-name>xml-to-html</servlet-name>
      <url-pattern>/opensocial/gadgets/ifr</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
      <servlet-name>metadata</servlet-name>
      <url-pattern>/opensocial/gadgets/metadata</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
      <servlet-name>gadgetsRestapiServlet</servlet-name>
      <url-pattern>/opensocial/social/rest/*</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
      <servlet-name>gadgetsJsonRpcServlet</servlet-name>
      <url-pattern>/opensocial/social/rpc/*</url-pattern>
    </servlet-mapping>
  </extension>
</fragment>
