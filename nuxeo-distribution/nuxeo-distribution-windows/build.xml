<?xml version="1.0"?>
<project name="Nuxeo Distribution JBoss" default="" basedir=".">
  <!-- Properties -->
  <property file="build.properties" />
  <property name="jboss.config" value="default" />
  <property name="jboss.dir" value="/opt/jboss" />
  <property name="project.build.directory" value="target" />

  <condition property="osfamily-macosx">
    <and>
      <os family="mac" />
      <os family="unix" />
    </and>
  </condition>
  <condition property="osfamily-unix">
    <and>
      <os family="unix" />
      <not>
        <os family="mac" />
      </not>
    </and>
  </condition>
  <condition property="osfamily-windows">
    <os family="windows" />
  </condition>

  <target name="package" depends="package-macosx,package-unix,package-windows" />
  <target name="package-macosx" if="osfamily-macosx">
    <property name="installer.path" value="${user.home}/.wine/drive_c/workspace/tools/win32Installer" />
    <property name="istool.path" value="${user.home}/.wine/drive_c/Program Files/ISTool" />
    <delete dir="${installer.path}" failonerror="false"/>
    <mkdir dir="${installer.path}" />
    <echo message="Update win32installer sources" />
    <exec executable="svn" failonerror="true">
      <arg value="co" />
      <arg value="http://svn.nuxeo.org/nuxeo/tools/win32Installer/trunk" />
      <arg value="${installer.path}" />
    </exec>
    <antcall target="prepare" />
    <echo message="Running ISTOOL with wine..." />
    <exec executable="/Applications/Darwine/Wine.bundle/Contents/bin/wine" failonerror="true">
      <arg value="${istool.path}/ISTool.exe" />
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup.iss" />
    </exec>
    <exec executable="/Applications/Darwine/Wine.bundle/Contents/bin/wine" failonerror="true">
      <arg value="${istool.path}/ISTool.exe" />
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup-64.iss" />
    </exec>
    <antcall target="retrieve" />
  </target>
  <target name="package-unix" if="osfamily-unix">
    <property name="installer.path" value="${user.home}/.wine/drive_c/workspace/tools/win32Installer" />
    <property name="istool.path" value="${user.home}/.wine/drive_c/Program Files/ISTool" />
    <delete dir="${installer.path}" failonerror="false"/>
    <mkdir dir="${installer.path}" />
    <echo message="Update win32installer sources" />
    <exec executable="svn" failonerror="true">
      <arg value="co" />
      <arg value="http://svn.nuxeo.org/nuxeo/tools/win32Installer/trunk" />
      <arg value="${installer.path}" />
    </exec>
    <antcall target="prepare" />
    <echo message="Running ISTOOL with wine..." />
    <exec executable="xvfb-run" failonerror="true">
      <arg value="-e" />
      <arg value="xvfb-run.err" />
      <arg value="wine" />
      <arg value="${istool.path}/ISTool.exe" />
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup.iss" />
    </exec>
    <exec executable="xvfb-run" failonerror="true">
      <arg value="-e" />
      <arg value="xvfb-run.err" />
      <arg value="wine" />
      <arg value="${istool.path}/ISTool.exe" />
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup-64.iss" />
    </exec>
    <antcall target="retrieve" />
  </target>

  <target name="package-windows" if="osfamily-windows">
    <property name="installer.path" value="C:/workspace/tools/win32Installer" />
    <property name="istool.path" value="C:/Program Files/ISTool" />
    <delete dir="${installer.path}" failonerror="false"/>
    <mkdir dir="${installer.path}" />
    <echo message="Update win32installer sources" />
    <exec executable="svn.exe" failonerror="true">
      <arg value="co" />
      <arg value="http://svn.nuxeo.org/nuxeo/tools/win32Installer/trunk" />
      <arg value="${installer.path}" />
    </exec>
    <antcall target="prepare" />
    <echo message="Running ISTOOL with wine..." />
    <exec executable="${istool.path}/ISTool.exe" failonerror="true">
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup.iss" />
    </exec>
    <exec executable="${istool.path}/ISTool.exe" failonerror="true">
      <arg value="-compile" />
      <arg value="${installer.path}/script/Nx5Setup-64.iss" />
    </exec>
    <antcall target="retrieve" />
  </target>

  <target name="prepare">
    <delete dir="${installer.path}/jboss/NuxeoServer" />
    <move file="${nuxeo-jboss.dir}" tofile="${installer.path}/jboss/NuxeoServer"/>
    <delete dir="${installer.path}/nxshell/NuxeoShell/" />
    <move file="${nuxeo-shell.dir}" tofile="${installer.path}/nxshell/NuxeoShell"/>
  </target>
  <target name="retrieve">
    <move todir="${project.build.directory}">
      <fileset dir="${installer.path}/script/Output/">
        <include name="*" />
      </fileset>
    </move>
  </target>
</project>
