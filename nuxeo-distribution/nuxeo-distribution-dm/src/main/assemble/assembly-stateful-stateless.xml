<project name="nuxeo-assembly-2parts"
         default="build"
         xmlns:nx="urn:nuxeo-build"
         xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />

  <target name="init" unless="init.done">
    <condition property="no.build">
      <and>
        <or>
          <isset property="maven.profile.vcs" />
          <isset property="maven.profile.nuxeo-ep" />
        </or>
        <not>
          <or>
            <isset property="maven.profile.all" />
            <isset property="maven.profile.all-distributions" />
            <isset property="maven.profile.nuxeo-2parts" />
          </or>
        </not>
      </and>
    </condition>
    <condition property="no.alternate.build">
      <not>
        <or>
          <isset property="maven.profile.all" />
          <isset property="maven.profile.all-distributions" />
        </or>
      </not>
    </condition>

    <property name="outdir" value="${maven.project.build.directory}" />
    <property name="stagedir" value="${outdir}/stage" />

    <antcall target="expand" />
    <property name="init.done" value="true" />
  </target>

  <target name="expand" unless="no.build">
    <artifact:nuxeo-expand />
    <!-- <artifact:print output="dependency-sf-tree.log" /> -->
  </target>

  <target name="build" depends="init,clean" unless="no.build">
    <echo>Building two parts Nuxeo DM EARs</echo>
    <property name="nuxeo.ear" value="${stagedir}/nuxeo.ear" />
    <mkdir dir="${nuxeo.ear}" />

    <antcall target="build-stateless" />
    <delete failonerror="false" dir="${outdir}/nuxeo.ear-web-stateless" />
    <copy todir="${outdir}/nuxeo-web-stateless.ear">
      <fileset dir="${nuxeo.ear}" />
    </copy>

    <antcall target="build-stateful" />
    <delete failonerror="false" dir="${outdir}/nuxeo.ear-platform-stateful" />
    <copy todir="${outdir}/nuxeo-platform-stateful.ear">
      <fileset dir="${nuxeo.ear}" />
    </copy>

    <antcall target="build-distribution-stateful">
      <param name="distribution" value="derby" />
    </antcall>
    <antcall target="build-distribution-stateful">
      <param name="distribution" value="mysql" />
    </antcall>
    <antcall target="build-distribution-stateful">
      <param name="distribution" value="postgresql" />
    </antcall>
    <antcall target="build-distribution-stateful">
      <param name="distribution" value="oracle" />
    </antcall>
    <antcall target="build-distribution-stateful">
      <param name="distribution" value="h2" />
    </antcall>

    <antcall target="clean" />
  </target>

  <target name="build-distribution-stateful"
          depends="init" unless="no.alternate.build"
          description="Build stateful distributions on various backends">
    <delete failonerror="false"
            dir="${stagedir}/nuxeo-platform-stateful-${distribution}.ear" />
    <copy todir="${stagedir}/nuxeo-platform-stateful-${distribution}.ear"
          overwrite="true">
      <fileset dir="${nuxeo.ear}" />
    </copy>
    <unzip dest="${stagedir}/nuxeo-platform-stateful-${distribution}.ear">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ear:${maven.project.version}:zip"
                            classifier="resources-${distribution}" />
    </unzip>
    <copy todir="${stagedir}/nuxeo-platform-stateful-${distribution}.ear"
          overwrite="true">
      <fileset dir="src/main/resources" />
    </copy>
    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-platform-stateful-${distribution}.zip"
         basedir="${stagedir}/nuxeo-platform-stateful-${distribution}.ear" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-platform-stateful-${distribution}.zip"
                     classifier="platform-stateful-${distribution}"
                     type="zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}" />
  </target>

  <target name="build-stateful"
          depends="init"
          description="Build platform stateful distribution">
    <!-- Nuxeo resources and modules -->
    <delete failonerror="false" dir="${nuxeo.ear}" />
    <unzip dest="${nuxeo.ear}">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ear:${maven.project.version}:zip"
                            classifier="resources-platform-stateful" />
    </unzip>
    <copy todir="${nuxeo.ear}" overwrite="true">
      <!-- Nuxeo DM specific properties -->
      <fileset dir="src/main/resources" />
    </copy>
    <copy todir="${nuxeo.ear}/system" overwrite="true">
      <artifact:set>
        <includes>
          <artifact groupId="org.nuxeo*"
                    category="runtime,jboss4"
                    dependsOnCategory="false" />
          <artifact groupId="org.nuxeo*" category="core,stateful" />
        </includes>
        <excludes>
          <artifact groupId="org.nuxeo.ecm.distribution"
                    artifactId="nuxeo-distribution-dm" />
          <artifact groupId="org.nuxeo.common" />
          <artifact artifactId="nuxeo-generic-wss-handler" />
          <artifact artifactId="nuxeo-platform-audit-facade" />
          <artifact artifactId="nuxeo-platform-placeful-facade" />
          <artifact artifactId="nuxeo-apt-extensions" />
          <artifact artifactId="nuxeo-webengine-apt" />
          <!-- exclude JCR storage -->
          <artifact artifactId="nuxeo-core-jca" />
          <artifact artifactId="nuxeo-core-jcr-connector" />
        </excludes>
      </artifact:set>
    </copy>
    <unzip dest="${nuxeo.ear}/system/nuxeo-platform-audit-facade-${nuxeo.features.version}.jar">
      <artifact:file artifactId="nuxeo-platform-audit-facade" />
    </unzip>
    <unzip dest="${nuxeo.ear}/system/nuxeo-platform-placeful-facade-${nuxeo.services.version}.jar">
      <artifact:file artifactId="nuxeo-platform-placeful-facade" />
    </unzip>

    <!-- Third-party libraries -->
    <antcall target="common-third-party-libraries" />
    <copy todir="${nuxeo.ear}/lib" overwrite="true">
      <!-- Remote publication lib -->
      <artifact:resolveFile key="org.apache.httpcomponents:httpclient" />
      <artifact:resolveFile key="org.apache.httpcomponents:httpcore" />
      <artifact:resolveFile key="net.sf.ehcache:ehcache" />
    </copy>

    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-platform-stateful.zip"
         basedir="${nuxeo.ear}" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-platform-stateful.zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     type="zip"
                     classifier="platform-stateful" />
  </target>

  <target name="build-stateless"
          description="Build web stateless distribution"
          depends="init">
    <!-- Nuxeo resources and modules -->
    <delete failonerror="false" dir="${nuxeo.ear}" />
    <unzip dest="${nuxeo.ear}">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ear:${maven.project.version}:zip"
                            classifier="resources-web-stateless" />
    </unzip>
    <copy todir="${nuxeo.ear}" overwrite="true">
      <!-- Nuxeo DM specific properties -->
      <fileset dir="src/main/resources" />
      <artifact:file artifactId="nuxeo-platform-webapp" />
      <artifact:file artifactId="nuxeo-platform-webapp-core" />
    </copy>
    <copy todir="${nuxeo.ear}/system" overwrite="true">
      <artifact:set>
        <includes>
          <artifact groupId="org.nuxeo*"
                    category="runtime,jboss4"
                    dependsOnCategory="false" />
          <artifact groupId="org.nuxeo*" category="stateless" />
        </includes>
        <excludes>
          <artifact groupId="org.nuxeo.ecm.distribution"
                    artifactId="nuxeo-distribution-dm" />
          <artifact groupId="org.nuxeo.common" />
          <artifact artifactId="nuxeo-generic-wss-handler" />
          <artifact artifactId="nuxeo-platform-webapp" />
          <artifact artifactId="nuxeo-platform-webapp-core" />
          <artifact artifactId="nuxeo-apt-extensions" />
          <artifact artifactId="nuxeo-webengine-apt" />
          <!-- exclude JCR storage -->
          <artifact artifactId="nuxeo-core-jca" />
          <artifact artifactId="nuxeo-core-jcr-connector" />
        </excludes>
      </artifact:set>
    </copy>

    <!-- Third-party libraries -->
    <antcall target="common-third-party-libraries" />

    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-web-stateless.zip"
         basedir="${nuxeo.ear}" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-web-stateless.zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     type="zip"
                     classifier="web-stateless" />
  </target>

  <target name="common-third-party-libraries"
          description="Common Third-party libraries">
    <copy todir="${nuxeo.ear}/lib" overwrite="true">
      <artifact:set>
        <includes>
          <artifact groupId="!org.nuxeo*" />
        </includes>
      </artifact:set>
    </copy>
    <!-- Temporary workaround waiting for NXP-3879 -->
    <delete>
      <fileset dir="${nuxeo.ear}/lib">
        <include name="EditableImage*" />
        <include name="JAI-Adapter*" />
        <include name="Operations*" />
        <include name="apacheds-core*" />
        <include name="apacheds-core-shared*" />
        <include name="apacheds-protocol-shared*" />
        <include name="c3p0*" />
        <include name="commons-httpclient*" />
        <include name="commons-lang*" />
        <include name="commons-logging*" />
        <include name="concurrent*" />
        <include name="custom_rhino*" />
        <include name="dom4j*" />
        <include name="ejb-3.0-RC8*" />
        <include name="ejb-api-3.0*" />
        <include name="ejb3-3.0-RC8*" />
        <include name="el-api-unknown*" />
        <include name="freemarker*" />
        <include name="geronimo-connector*" />
        <include name="geronimo-jta_1.1_spec*" />
        <include name="gwt-dev*" />
        <include name="gwt-gadgets*" />
        <include name="gwt-log*" />
        <include name="gwt-user*" />
        <include name="gwtext*" />
        <include name="h2-1.1.114*" />
        <include name="hibernate-3.2.4.SP1_CP01-brew_NXP-3881-NXP-4604*" />
        <include name="hibernate-annotations*" />
        <include name="hibernate-entitymanager*" />
        <include name="imagej*" />
        <include name="jackrabbit-api*" />
        <include name="jackrabbit-core*" />
        <include name="jackrabbit-jcr-commons*" />
        <include name="jackrabbit-spi*" />
        <include name="jackrabbit-text-extractors*" />
        <include name="jai_codec*" />
        <include name="jai_core*" />
        <include name="jboss-4.0.4.GA*" />
        <include name="jboss-annotations-ejb3-3.0-RC8*" />
        <include name="jboss-common*" />
        <include name="jboss-j2ee*" />
        <include name="jboss-jmx*" />
        <include name="jboss-remoting*" />
        <include name="jboss-system*" />
        <include name="jbosssx*" />
        <include name="jca-api*" />
        <include name="jcip-annotations*" />
        <include name="jcr*" />
        <include name="jetty-annotations*" />
        <include name="jetty-naming*" />
        <include name="jetty-plus*" />
        <include name="jetty-util*" />
        <include name="jms*" />
        <include name="jsf-api*" />
        <include name="jsf-impl*" />
        <include name="jsp-api*" />
        <include name="jsr181*" />
        <include name="jsr250-api*" />
        <include name="jta*" />
        <include name="mail*" />
        <include name="metadata-extractor*" />
        <include name="mlib_jai*" />
        <include name="persistence*" />
        <include name="persistence-api*" />
        <include name="postgresql*" />
        <include name="quartz-all*" />
        <include name="servlet-api*" />
        <include name="shindig-common*" />
        <include name="shindig-features*" />
        <include name="shindig-gadgets*" />
        <include name="shindig-social-api*" />
        <include name="webservices-api*" />
        <include name="xercesImpl*" />
        <include name="xml-apis*" />
        <include name="xmlParserAPIs*" />
      </fileset>
    </delete>
    <copy todir="${nuxeo.ear}/lib" overwrite="true">
      <artifact:resolveFile key="org.jboss.el:jboss-el" />
      <artifact:resolveFile key="jboss:jboss-cache-jdk50" />
      <artifact:resolveFile key="org.jboss.seam:jboss-seam-remoting" />
      <artifact:resolveFile key="org.jboss.seam:jboss-seam-mail" />
      <artifact:resolveFile key="org.jboss.seam:jboss-seam-debug" />
      <artifact:resolveFile key="jboss:jgroups" />
      <artifact:resolveFile key="bouncycastle:bcmail-jdk14" />
      <artifact:resolveFile key="bouncycastle:bcprov-jdk14" />
      <artifact:resolveFile key="org.slf4j:slf4j-api" />
      <artifact:resolveFile key="org.slf4j:slf4j-log4j12" />
      <artifact:resolveFile key="org.apache.directory.server:apacheds-protocol-shared" />
      <artifact:resolveFile key="org.openoffice:jurt" />
      <artifact:resolveFile key="org.fontbox:fontbox" />
      <artifact:resolveFile key="org.jempbox:jempbox" />
      <artifact:resolveFile key="org.apache.poi:ooxml-schemas" />
      <artifact:resolveFile key="org.apache.httpcomponents:httpcore" />
      <artifact:resolveFile key="com.google.collections:google-collections" />
    </copy>
  </target>

  <target name="clean">
    <delete dir="${stagedir}" />
  </target>

</project>
