<?xml version="1.0"?>
<project xmlns:artifact="urn:nuxeo-artifact"
         xmlns:nx="urn:nuxeo-build"
         default="build"
         name="nuxeo-assembly">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />
  <condition property="osfamily-unix">
    <os family="unix" />
  </condition>
  <condition property="osfamily-windows">
    <os family="windows" />
  </condition>
  
  <target name="init">
    <property name="outdir" value="${maven.project.build.directory}" />
    <available file="${custom.pack.config}" property="isCustomPack" />
    <nx:if isSet="isCustomPack">
      <echo>Using custom pack configuration: ${custom.pack.config}</echo>
      <loadproperties srcFile="${custom.pack.config}" />
    </nx:if>
    <!-- load default properties -->
    <loadproperties srcFile="${maven.basedir}/default.properties" />
  </target>
  
  <target name="clean">
    <delete dir="${outdir}" failonerror="false" />
    <mkdir dir="${outdir}" />
  </target>
  
  <target depends="init,clean" name="build">
    <unzip dest="${outdir}">
      <artifact:resolveFile key="${NX_DISTRIBUTION}" />
      <patternset>
        <exclude name="**/bundles/nuxeo-platform-wi-backend*.jar" />
        <exclude name="**/lib/nuxeo-generic-wss-handler*.jar" />
      </patternset>
    </unzip>
    <nx:rename from="${outdir}/*" to="${outdir}/stage" />
    <property name="stage" value="${outdir}/stage" />
    <antcall target="pack" />
  </target>
  
  <target name="pack">
    <echo>Packing distribution: ${NX_DISTRIBUTION}</echo>
    <chmod dir="${stage}/bin" includes="*.sh,*ctl,*.command" perm="ug+x" />
    <!-- patch the distribution according to the pack configuration -->
    <!-- generate nuxeo structure xml file -->
    <loadfile property="nxstructure"
              srcFile="${maven.basedir}/nuxeo-structure.xml">
      <filterchain>
        <filterreader classname="org.apache.tools.ant.filters.ExpandProperties" />
      </filterchain>
    </loadfile>
    <echo append="false" file="${stage}${ORIG_NX_STRUCTURE}">${nxstructure}</echo>
    <!-- disable var. expansion -->
    <echo>Patch nuxeo.conf</echo>
    <echo append="true" file="${stage}/bin/nuxeo.conf">

#======================== Generated by EAR Pack tool =========================

#nuxeo.templates.parsing.extensions=null

        </echo>
    <concat append="true" destfile="${stage}/bin/nuxeo.conf">
      <fileset file="${maven.basedir}/default.properties" />
    </concat>
    <nx:if isSet="isCustomPack">
      <concat append="true" destfile="${stage}/bin/nuxeo.conf">
        <fileset file="${custom.pack.config}" />
      </concat>
    </nx:if>

    <!-- run the pack command -->
    <echo>Executing pack command</echo>
    <antcall target="run-pack" />
    <antcall target="libs" />
    <delete dir="${stage}" />
  </target>
  
  <target name="run-pack" depends="run-pack-windows,run-pack-unix" />
  <target name="run-pack-windows" if="osfamily-windows">
    <exec executable="${stage}/bin/pack.bat">
       <arg value="${outdir}/deploy" />
    </exec>
  </target>
  <target name="run-pack-unix" if="osfamily-unix">
     <exec executable="${stage}/bin/pack">
       <arg value="${outdir}/deploy" />
     </exec>
  </target>

  <target name="libs">
    <delete dir="${outdir}/lib" failonerror="false" />
    <mkdir dir="${outdir}/lib" />
    <move todir="${outdir}/lib">
      <fileset dir="${stage}/server/default/lib" />
    </move>
  </target>
</project>
