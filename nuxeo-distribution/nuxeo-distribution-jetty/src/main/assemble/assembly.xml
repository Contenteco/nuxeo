<project name="nuxeo-assembly"
         default="build"
         xmlns:nx="urn:nuxeo-build"
         xmlns:artifact="urn:nuxeo-artifact">
  <taskdef resource="org/nuxeo/build/antlib.xml" uri="urn:nuxeo-build" />
  <taskdef resource="org/nuxeo/build/artifact/antlib.xml"
           uri="urn:nuxeo-artifact" />

  <target name="init" unless="init.done">
    <property name="outdir" value="${maven.project.build.directory}" />
    <property name="stagedir" value="${outdir}/stage" />
    <antcall target="expand" />
    <property name="init.done" value="true" />
  </target>

  <target name="expand" unless="no.build">
    <artifact:nuxeo-expand />
  </target>

  <target name="build" depends="init" unless="no.build">
    <echo>Building Jetty distributions...</echo>
    <property name="jetty" value="${stagedir}/jetty" />

    <antcall target="prepare-jetty" />
    <antcall target="build-nuxeo-ep-jetty" />
    <antcall target="build-nuxeo-dm-jetty" />
  </target>

  <target name="prepare-jetty">
    <unzip dest="${jetty}">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-server:${maven.project.version}:zip" />
    </unzip>
    <copy todir="${jetty}">
      <fileset dir="src/main/resources" />
    </copy>
    <delete file="${jetty}/config/login-anonymous-config.xml" />
    <chmod dir="${jetty}" perm="750" includes="*.sh" />
    <copy todir="${jetty}/bundles">
      <artifact:resolveFile key="org.nuxeo.runtime:nuxeo-runtime-jetty-adapter" />
      <artifact:resolveFile key="org.nuxeo.runtime:nuxeo-runtime-deploy" />
      <artifact:resolveFile key="org.nuxeo.ecm.core:nuxeo-core-storage-sql" />
      <artifact:resolveFile key="org.nuxeo.ecm.core:nuxeo-core-storage-sql-extensions" />
    </copy>
    <antcall target="jetty-third-party-libraries">
      <param name="lib.dir" value="${jetty}/lib" />
    </antcall>
  </target>

  <target name="build-nuxeo-ep-jetty"
          unless="maven.profile.nuxeo-dm"
          description="Build Jetty distribution with Nuxeo EP">
    <delete failonerror="false" dir="${outdir}/nuxeo-ep-jetty" />
    <copy todir="${outdir}/nuxeo-ep-jetty">
      <fileset dir="${jetty}" />
    </copy>
    <unzip dest="${outdir}/nuxeo-ep-jetty/bundles">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-platform-ear:${nuxeo.features.version}:zip" />
      <patternset>
        <include name="nuxeo-platform-webapp*.jar" />
        <include name="plugins/*.*" />
        <include name="system/*.*" />
        <exclude name="system/nuxeo-platform-auth-web-jboss*" />
        <exclude name="system/nuxeo-platform-login-jboss*" />
        <exclude name="system/nuxeo-runtime-jboss-adapter*" />
        <exclude name="system/*.pom" />
        <exclude name="system/*facade*" />
        <exclude name="system/*facade*/**" />
      </patternset>
      <mapper type="flatten" />
    </unzip>
    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-nuxeo-ep.zip"
         basedir="${outdir}"
         includes="nuxeo-ep-jetty/**" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-nuxeo-ep.zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     classifier="nuxeo-ep"
                     type="zip" />
  </target>

  <target name="build-nuxeo-dm-jetty"
          unless="maven.profile.nuxeo-ep"
          description="Build jetty distribution with Nuxeo DM">
    <delete failonerror="false" dir="${outdir}/nuxeo-dm-jetty" />
    <copy todir="${outdir}/nuxeo-dm-jetty">
      <fileset dir="${jetty}" />
    </copy>
    <copy todir="${outdir}/nuxeo-dm-jetty/bundles">
      <artifact:resolveFile key="org.nuxeo.ecm.platform:nuxeo-generic-wss-handler" />
    </copy>
    <unzip dest="${outdir}/nuxeo-dm-jetty/bundles">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-dm:${nuxeo.distribution.version}:zip" />
      <patternset>
        <include name="nuxeo-platform-webapp*.jar" />
        <include name="plugins/*.*" />
        <include name="system/*.*" />
        <exclude name="system/nuxeo-platform-auth-web-jboss*" />
        <exclude name="system/nuxeo-platform-login-jboss*" />
        <exclude name="system/nuxeo-runtime-jboss-adapter*" />
        <exclude name="system/*.pom" />
        <exclude name="system/*facade*" />
        <exclude name="system/*facade*/**" />
      </patternset>
      <mapper type="flatten" />
    </unzip>
    <zip destfile="${outdir}/${maven.project.artifactId}-${maven.project.version}-nuxeo-dm.zip"
         basedir="${outdir}"
         includes="nuxeo-dm-jetty/**" />
    <artifact:attach file="${outdir}/${maven.project.artifactId}-${maven.project.version}-nuxeo-dm.zip"
                     target="${maven.project.groupId}:${maven.project.artifactId}"
                     classifier="nuxeo-dm"
                     type="zip" />
  </target>

  <target name="jetty-third-party-libraries">
    <!-- Remove duplicate, not needed and/or wrong third-parties -->
    <delete>
      <filelist dir="${lib.dir}">
        <file name="javassist-3.6.jar" />
        <file name="servlet-api-2.4.jar" />
        <file name="el-api-unknown.jar" />
        <file name="el-ri-unknown.jar" />
      </filelist>
    </delete>
    <!-- Add libraries required under jetty (not present in the dependency tree) -->
    <copy todir="${lib.dir}" overwrite="true">
      <!-- Synchro Added packages -->
      <artifact:resolveFile key="javax.activation:activation" />
      <artifact:resolveFile key="apache-httpclient:commons-httpclient" />
      <artifact:resolveFile key="commons-codec:commons-codec" />
      <artifact:resolveFile key="metro.webservices:webservices-api" />
      <artifact:resolveFile key="metro.webservices:webservices-rt" />
      <artifact:resolveFile key="metro.webservices:webservices-tools" />
      <!-- End Synchro Added packages -->

      <artifact:resolveFile key="javax.servlet:servlet-api" />
      <artifact:resolveFile key="org.mortbay.jetty:jetty" />
      <artifact:resolveFile key="org.mortbay.jetty:jetty-plus" />
      <artifact:resolveFile key="org.mortbay.jetty:jetty-naming" />
      <artifact:resolveFile key="org.mortbay.jetty:jetty-annotations" />
      <artifact:resolveFile key="org.mortbay.jetty:jetty-util" />
      <artifact:resolveFile key="jotm:jotm" />
      <artifact:resolveFile key="javax.ejb:ejb-api" />
      <artifact:resolveFile key="javax.transaction:jta" />
      <artifact:resolveFile key="javax.annotation:jsr250-api" />

      <artifact:resolveFile key="org.apache.ant:ant" />
      <artifact:resolveFile key="bsh:bsh" />
      <artifact:resolveFile key="commons-el:commons-el" />
      <artifact:resolveFile key="commons-digester:commons-digester" />
      <artifact:resolveFile key="org.jboss.el:jboss-el" />

      <artifact:resolveFile key="org.jboss.seam:jboss-seam" />
      <artifact:resolveFile key="org.jboss.seam:jboss-seam-debug" />
      <artifact:resolveFile key="org.jboss.seam:jboss-seam-mail" />
      <artifact:resolveFile key="org.jboss.seam:jboss-seam-ui" />
      <artifact:resolveFile key="org.jboss.seam:jboss-seam-remoting" />

      <artifact:resolveFile key="org.jbpm.jbpm3:jbpm-jpdl" />

      <artifact:resolveFile key="org.openoffice:ridl" />
      <artifact:resolveFile key="org.openoffice:juh" />
      <artifact:resolveFile key="org.openoffice:unoil" />
      <artifact:resolveFile key="org.openoffice:jurt" />
      <artifact:resolveFile key="com.artofsolving:jodconverter" />
      <artifact:resolveFile key="com.thoughtworks.xstream:xstream" />
      <artifact:resolveFile key="pdfbox:pdfbox" />
      <artifact:resolveFile key="org.fontbox:fontbox" />
      <artifact:resolveFile key="org.jempbox:jempbox" />
      <artifact:resolveFile key="bouncycastle:bcmail-jdk14" />
      <artifact:resolveFile key="bouncycastle:bcprov-jdk14" />

      <artifact:resolveFile key="org.richfaces.framework:richfaces-api" />
      <artifact:resolveFile key="org.richfaces.framework:richfaces-impl" />
      <artifact:resolveFile key="org.richfaces.ui:richfaces-ui" />
      <artifact:resolveFile key="org.richfaces.framework:richfaces-api" />
      <artifact:resolveFile key="javax.script:script-api" />
      <artifact:resolveFile key="org.apache.lucene:lucene-analyzers" />

      <artifact:resolveFile key="com.sun.facelets:jsf-facelets" />
      <artifact:resolveFile key="javax.faces:jsf-api" />
      <artifact:resolveFile key="javax.faces:jsf-impl" />

      <artifact:resolveFile key="org.mortbay.jetty:jsp-api-2.1" />
      <artifact:resolveFile key="org.mortbay.jetty:jsp-2.1" />

      <artifact:resolveFile key="jboss:javassist" />

      <artifact:resolveFile key="com.h2database:h2" />

      <artifact:resolveFile key="org.eclipse.jdt:core" />

      <artifact:resolveFile key="com.sun.xml:relaxngDatatype" />
      <artifact:resolveFile key="com.sun.xml:xsom" />
      <artifact:resolveFile key="cup:java-cup" />
      <artifact:resolveFile key="joda-time:joda-time" />
      <artifact:resolveFile key="org.wikimodel:wem" />

      <artifact:resolveFile key="com.hp.hpl.jena:jena" />
      <artifact:resolveFile key="com.hp.hpl.jena:arq" />
      <artifact:resolveFile key="com.hp.hpl.jena:iri" />
      <artifact:resolveFile key="com.ibm.icu:icu4j" />

      <artifact:resolveFile key="rome:rome" />
      <artifact:resolveFile key="jdom:jdom" />

      <artifact:resolveFile key="jmimemagic:jmimemagic" />
      <artifact:resolveFile key="org.apache.poi:ooxml-schemas" />
      <artifact:resolveFile key="org.apache.poi:poi" />
      <artifact:resolveFile key="org.apache.poi:poi-ooxml" />
      <artifact:resolveFile key="org.apache.poi:poi-scratchpad" />
      <artifact:resolveFile key="org.apache:xmlbeans" />
      <artifact:resolveFile key="oro:oro" />
      <artifact:resolveFile key="opensymphony:quartz-all" />

      <artifact:resolveFile key="net.sf.ehcache:ehcache" />
      <artifact:resolveFile key="com.google.collections:google-collections" />
      <artifact:resolveFile key="com.google.gwt:gwt-servlet" />
      <artifact:resolveFile key="backport-util-concurrent:backport-util-concurrent" />

      <!-- Remote publication lib -->
      <artifact:resolveFile key="org.apache.httpcomponents:httpclient" />
      <artifact:resolveFile key="org.apache.httpcomponents:httpcore" />
    </copy>
  </target>

  <target name="clean">
    <delete dir="${stagedir}" />
  </target>

</project>
