<project name="nuxeo-assembly" default="build" xmlns:nx="urn:nuxeo-build" xmlns:artifact="urn:nuxeo-artifact">
  <property file="build.properties" />   
  <property name="outdir" value="${basedir}/target" />
  <property name="stagedir" value="${basedir}/target/stage" />
  
  <import file="settings.xml" />

  <target name="build" depends="settings,clean">
    <echo>Entering tomcat build</echo>
    <property name="tomcat" value="${stagedir}/nuxeo-dm-tomcat"/>
    <property name="nxserver" value="${tomcat}/webapps/nuxeo/nxserver"/>

    
    <mkdir dir="${stagedir}" /> 

    <unzip dest="${stagedir}">
      <artifact:resolveFile key="org.apache.tomcat:apache-tomcat:6.0.20:zip" />
    </unzip>
    
    <nx:rename from="${stagedir}/apache-tomcat*" to="${tomcat}"/>

    <unzip dest="${tomcat}/webapps/nuxeo">
      <artifact:resolveFile key="org.nuxeo.ecm.distribution:nuxeo-distribution-jetty:${nuxeo.platform.version}:zip" />
    </unzip>

    <nx:rename from="${tomcat}/webapps/nuxeo/nuxeo-*" to="${tomcat}/webapps/nuxeo/nxserver" />
    
    <copy todir="${tomcat}">
      <fileset dir="resources" />      
    </copy>
        
    <delete>
      <fileset dir="${nxserver}" includes="nuxeo-runtime-launcher-*" />
      <fileset dir="${nxserver}/bundles" includes="nuxeo-runtime-jetty-*" />
      <!--fileset dir="${nxserver}/bundles" includes="nuxeo-platform-virtualnavigation-*" /-->
      <fileset dir="${nxserver}/lib" includes="core-*" />
      <!-- jetty-util is needed by jsp impl jar - whic is referring jetty log classes -->
      <fileset dir="${nxserver}/lib" includes="jetty-*" excludes="jetty-util*" />
      <fileset dir="${nxserver}/lib" includes="jsp-api*" />
      <fileset dir="${nxserver}/lib" includes="servlet-api-*" />
      <fileset dir="${nxserver}/lib" includes="el-api*" />
      <fileset dir="${nxserver}/lib" includes="jsp-*" />      
    </delete>
    
    <!-- we need el-ri impl in lib - why this is not part of jetty distrib? -->
    <copy todir="${nxserver}/lib">
      <artifact:resolveFile key="com.google.gwt:gwt-servlet:1.7.0:jar" />
      <artifact:resolveFile key="jstl:jstl:1.1.2:jar" />
      <artifact:resolveFile key="javax.el:el-ri:unknown:jar" />    
      <!--artifact:resolveFile key="javax.el:el-api:unknown:jar" /-->
    </copy>

    <move todir="${tomcat}/webapps/nuxeo/WEB-INF/lib">    
      <fileset dir="${nxserver}/lib" includes="jsf-impl-*" />
    </move>
    
    <copy todir="${tomcat}/lib">
      <artifact:resolveFile key="org.nuxeo.runtime:nuxeo-runtime-tomcat-adapter:${nuxeo.runtime.version}:jar" />
    </copy>
    <move todir="${tomcat}/lib">
      <fileset dir="${nxserver}/lib" includes="derby-*" />
    </move>

    <echo>Running nuxeo build processor</echo>    
    <nx:preprocess src="${nxserver}" />
    
    <echo>Copying war files</echo>
    <move todir="${tomcat}/webapps/nuxeo">
      <fileset dir="${nxserver}/nuxeo.war" includes="**/*"/>
    </move>
    
    <!-- make the final zip -->
    <zip destfile="${outdir}/nuxeo-dm-tomcat-${version}.zip" basedir="${stagedir}"/>
    
  </target>
  
  
  <target name="clean">
    <delete dir="${stagedir}" />
  </target>

  <target name="cleanall">
    <delete dir="${outdir}" />
  </target>
  
</project>
